---
phase: 01-foundation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - ".env.example"
  - ".env.local"
  - "package.json"
  - "lib/supabase/client.ts"
  - "lib/supabase/server.ts"
autonomous: true
must_haves:
  truths:
    - "Environment variables are configured with Supabase credentials"
    - "npm install completes with all auth dependencies"
    - "Supabase browser client works in client components"
    - "Supabase server client works in server components"
  artifacts:
    - path: ".env.example"
      provides: "Environment variable template with all Supabase keys"
    - path: ".env.local"
      provides: "Local environment configuration"
    - path: "lib/supabase/client.ts"
      provides: "Browser client for client components"
    - path: "lib/supabase/server.ts"
      provides: "Server client for SSR and API routes"
  key_links:
    - from: "lib/supabase/client.ts"
      to: "NEXT_PUBLIC_SUPABASE_URL"
      via: "Environment variable reference"
    - from: "lib/supabase/server.ts"
      to: "NEXT_PUBLIC_SUPABASE_ANON_KEY"
      via: "Environment variable reference"
provides_interface:
  - name: createBrowserClient
    type: function
    description: "Creates Supabase browser client for client components"
  - name: createServerClient
    type: function
    description: "Creates Supabase server client for SSR and API routes"
assumes_from: []
user_setup:
  - service: supabase
    why: "Database backend and authentication provider"
    env_vars:
      - name: "NEXT_PUBLIC_SUPABASE_URL"
        source: "Supabase Dashboard -> Project Settings -> API -> URL"
      - name: "NEXT_PUBLIC_SUPABASE_ANON_KEY"
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
      - name: "SUPABASE_SERVICE_ROLE_KEY"
        source: "Supabase Dashboard -> Project Settings -> API -> service_role secret"
---

<objective>
Establish the Supabase foundation with @supabase/ssr authentication infrastructure. This wave creates the essential client utilities for browser and server authentication, ensuring secure session handling across the application.

Purpose: Enable authenticated user sessions with proper cookie management for Next.js 14 App Router
Output: Configured environment, installed dependencies, and reusable client utilities
</objective>

<execution_context>
{file:~/.config/opencode/gsd/workflows/execute-plan.md}
{file:~/.config/opencode/gsd/templates/summary.md}
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-FOUNDATION/01-RESEARCH.md
@.planning/phases/01-FOUNDATION/CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment variable template</name>
  <files>.env.example</files>
  <action>
    Create `.env.example` with all required Supabase and application environment variables. Include comments explaining each variable's purpose and where to find values in Supabase Dashboard.

    Required variables:
    - NEXT_PUBLIC_SUPABASE_URL (Supabase Dashboard -> Settings -> API)
    - NEXT_PUBLIC_SUPABASE_ANON_KEY (Supabase Dashboard -> Settings -> API)
    - SUPABASE_SERVICE_ROLE_KEY (Supabase Dashboard -> Settings -> API)
    - NEXT_PUBLIC_APP_URL (application URL, typically http://localhost:3000)

    Format: KEY=placeholder_value # Description
  </action>
  <verify>
    grep -c "NEXT_PUBLIC_SUPABASE" .env.example && echo "4 Supabase env vars found"
    grep -c "=" .env.example && echo "All variables have = sign"
  </verify>
  <done>
    ".env.example exists with 4 Supabase variables and application URL"
  </done>
</task>

<task type="auto">
  <name>Task 2: Install authentication dependencies</name>
  <files>package.json</files>
  <action>
    Install required dependencies for Phase 1 authentication:

    ```bash
    npm install @supabase/ssr@^0.5.0 @supabase/supabase-js@^2.39.0
    npm install -D @types/pg@^8.10.0 kysely-codegen@^0.14.0
    ```

    Update package.json devDependencies and dependencies sections. Ensure versions match RESEARCH.md specifications.
  </action>
  <verify>
    cat package.json | grep -A 5 '"dependencies"' | grep -E "@supabase/(ssr|supabase-js)" | head -2
    cat package.json | grep -A 3 '"devDependencies"' | grep -E "(kysely-codegen|@types/pg)" | head -2
  </verify>
  <done>
    "package.json contains @supabase/ssr ^0.5.0, @supabase/supabase-js ^2.39.0, kysely-codegen ^0.14.0, @types/pg ^8.10.0"
  </done>
</task>

<task type="auto">
  <name>Task 3: Create browser client for client components</name>
  <files>lib/supabase/client.ts</files>
  <action>
    Create `lib/supabase/client.ts` exporting a function to create Supabase browser client.

    Pattern from RESEARCH.md:
    ```typescript
    import { createBrowserClient } from '@supabase/ssr'

    export function createBrowserClient() {
      return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!
      )
    }
    ```

    Note: Use `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` (not ANON_KEY) for browser client. Export as default or named export.
  </action>
  <verify>
    cat lib/supabase/client.ts | grep -c "createBrowserClient"
    cat lib/supabase/client.ts | grep -c "NEXT_PUBLIC_SUPABASE_URL"
  </verify>
  <done>
    "lib/supabase/client.ts exports createBrowserClient with proper environment variable references"
  </done>
</task>

<task type="auto">
  <name>Task 4: Create server client for SSR and API routes</name>
  <files>lib/supabase/server.ts</files>
  <action>
    Create `lib/supabase/server.ts` exporting a function to create Supabase server client with cookie handling.

    Pattern from RESEARCH.md:
    ```typescript
    import { createServerClient } from '@supabase/ssr'
    import { cookies } from 'next/headers'

    export async function createServerClient() {
      const cookieStore = await cookies()

      return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
          cookies: {
            getAll() { return cookieStore.getAll() },
            setAll(cookiesToSet) {
              try {
                cookiesToSet.forEach(({ name, value, options }) =>
                  cookieStore.set(name, value, options)
                )
              } catch {
                // Call from Server Component - ignore, middleware handles refresh
              }
            },
          },
        }
      )
    }
    ```

    Include error handling for Server Component context as shown in RESEARCH.md.
  </action>
  <verify>
    cat lib/supabase/server.ts | grep -c "createServerClient"
    cat lib/supabase/server.ts | grep -c "cookies()"
    cat lib/supabase/server.ts | grep -c "getAll\|setAll"
  </verify>
  <done>
    "lib/supabase/server.ts exports createServerClient with async cookie handling and error suppression for Server Components"
  </done>
</task>

</tasks>

<verification>
Run verification commands to confirm wave 1 completion:
```bash
cat .env.example | grep -E "NEXT_PUBLIC_SUPABASE" | wc -l
cat package.json | grep -E "@supabase/(ssr|supabase-js)" | wc -l
cat lib/supabase/client.ts | grep "createBrowserClient" | wc -l
cat lib/supabase/server.ts | grep "createServerClient" | wc -l
```
Expected: 4 env vars, 2 deps, 1 client function, 1 server function
</verification>

<success_criteria>
- [ ] `.env.example` created with all Supabase environment variables documented
- [ ] `package.json` updated with all authentication dependencies at correct versions
- [ ] `lib/supabase/client.ts` creates browser client for client components
- [ ] `lib/supabase/server.ts` creates server client with cookie handling
- [ ] All files pass TypeScript compilation (no import errors)
</success_criteria>

<output>
After completion, create `.planning/phases/01-FOUNDATION/01-01-SUMMARY.md`
</output>
