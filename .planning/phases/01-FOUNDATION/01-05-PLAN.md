---
phase: 01-foundation
plan: "05"
type: execute
wave: 5
depends_on:
  - "01-03"
  - "01-04"
files_modified:
  - "lib/auth/mfa.ts"
  - "app/(dashboard)/settings/security/enroll/page.tsx"
  - "lib/auth/admin-middleware.ts"
  - "app/api/auth/mfa/challenge/route.ts"
autonomous: true
must_haves:
  truths:
    - "Admin users can enroll in MFA using authenticator apps"
    - "MFA enrollment provides QR code and secret for authenticator setup"
    - "Admin accounts require MFA for dashboard access"
    - "MFA verification challenges are enforced on sensitive operations"
  artifacts:
    - path: "lib/auth/mfa.ts"
      provides: "MFA enrollment, verification, and status checking functions"
    - path: "app/(dashboard)/settings/security/enroll/page.tsx"
      provides: "MFA enrollment UI with QR code display"
    - path: "lib/auth/admin-middleware.ts"
      provides: "Admin-only access enforcement with MFA requirement"
  key_links:
    - from: "lib/auth/mfa.ts"
      to: "@supabase/auth"
      via: "Supabase MFA API (enroll, challenge, verify)"
    - from: "app/(dashboard)/settings/security/enroll/page.tsx"
      to: "lib/auth/mfa.ts"
      via: "Enrollment and verification server actions"
    - from: "lib/auth/admin-middleware.ts"
      to: "lib/auth/mfa.ts"
      via: "MFA status check for admin enforcement"
provides_interface:
  - name: enrollMFA
    type: function
    description: "Initiates MFA enrollment, returns QR code and secret"
  - name: verifyEnrollment
    type: function
    description: "Verifies TOTP code during enrollment"
  - name: checkMFAStatus
    type: function
    description: "Returns MFA enabled status and factors"
  - name: requireAdminMFA
    type: function
    description: "Redirects to MFA enrollment if admin without MFA"
  - name: verifyMFAForAction
    type: function
    description: "Verifies MFA before executing sensitive action"
assumes_from:
  - phase: 1
    interface: createServerClient
    usage: "Used for MFA API calls to Supabase Auth"
---

<objective>
Implement multi-factor authentication for admin accounts using Supabase TOTP provider. This wave creates the enrollment flow with QR codes, verification challenge, and middleware that enforces MFA for admin access.

Purpose: Security enforcement requiring MFA for admin account access
Output: MFA enrollment UI, verification functions, and admin middleware
</objective>

<execution_context>
{file:~/.config/opencode/gsd/workflows/execute-plan.md}
{file:~/.config/opencode/gsd/templates/summary.md}
</execution_context>

<context>
@.planning/phases/01-FOUNDATION/01-RESEARCH.md

# MFA patterns from research
# - Supabase built-in TOTP provider
# - MFA enrollment returns QR code for authenticator apps
# - Admin enforcement via middleware redirect
# - Factor ID stored for challenge/verify operations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MFA utility functions</name>
  <files>lib/auth/mfa.ts</files>
  <action>
    Create `lib/auth/mfa.ts` with all MFA operations.

    **enrollMFA function:**
    ```typescript
    import { createServerClient } from '@/lib/supabase/server'

    export interface MFAEnrollmentResult {
      qrCode: string // Data URL for QR code image
      secret: string // TOTP secret for manual entry
      factorId: string // Factor ID for verification
    }

    export async function enrollMFA(): Promise<MFAEnrollmentResult> {
      const supabase = await createServerClient()

      const { data, error } = await supabase.auth.mfa.enroll({
        factorType: 'totp',
        friendlyName: 'Authenticator App',
      })

      if (error) {
        throw new Error('Failed to enroll MFA: ' + error.message)
      }

      return {
        qrCode: data.totp.qr_code,
        secret: data.totp.secret,
        factorId: data.id,
      }
    }
    ```

    **verifyEnrollment function:**
    ```typescript
    export async function verifyEnrollment(factorId: string, code: string) {
      const supabase = await createServerClient()

      const { error } = await supabase.auth.mfa.challengeAndVerify({
        factorId,
        code,
      })

      if (error) {
        throw new Error('Invalid verification code: ' + error.message)
      }

      return { success: true }
    }
    ```

    **checkMFAStatus function:**
    ```typescript
    export interface MFAStatus {
      enabled: boolean
      factors: Array<{
        id: string
        factorType: string
        status: 'verified' | 'unverified'
        friendlyName: string
      }>
    }

    export async function checkMFAStatus(): Promise<MFAStatus> {
      const supabase = await createServerClient()

      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        return { enabled: false, factors: [] }
      }

      const { data: factors } = await supabase.auth.mfa.listFactors()

      return {
        enabled: factors?.totp?.some(f => f.status === 'verified') ?? false,
        factors: factors?.all ?? [],
      }
    }
    ```

    **verifyMFAForAction helper:**
    ```typescript
    export async function verifyMFAForAction(
      factorId: string,
      code: string,
      action: () => Promise<void>
    ): Promise<void> {
      const supabase = await createServerClient()

      // First verify MFA
      const { error: verifyError } = await supabase.auth.mfa.verify({
        factorId,
        code,
      })

      if (verifyError) {
        throw new Error('Invalid MFA code')
      }

      // Then execute the action
      await action()
    }
    ```
  </action>
  <verify>
    cat lib/auth/mfa.ts | grep -c "export async function"
    cat lib/auth/mfa.ts | grep -c "mfa.enroll"
    cat lib/auth/mfa.ts | grep -c "mfa.challengeAndVerify"
  </verify>
  <done>
    "lib/auth/mfa.ts created with enroll, verify, and status checking functions"
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MFA enrollment UI</name>
  <files>app/(dashboard)/settings/security/enroll/page.tsx</files>
  <action>
    Create `app/(dashboard)/settings/security/enroll/page.tsx` for MFA setup.

    Include:
    - QR code display (from enrollment response)
    - Secret key display (for manual entry)
    - Verification code input (6 digits)
    - Verify button
    - Error handling and success state
    - Back to settings link

    Server action for enrollment and verification:
    ```typescript
    'use server'

    import { enrollMFA, verifyEnrollment } from '@/lib/auth/mfa'
    import { redirect } from 'next/navigation'
    import { revalidatePath } from 'next/cache'

    export async function startEnrollment() {
      'use server'
      return await enrollMFA()
    }

    export async function completeEnrollment(formData: FormData) {
      'use server'
      const factorId = formData.get('factorId') as string
      const code = formData.get('code') as string

      await verifyEnrollment(factorId, code)
      revalidatePath('/settings/security')
      redirect('/settings/security?enrolled=true')
    }
    ```

    Page component:
    ```tsx
    import { startEnrollment, completeEnrollment } from './actions'
    import { createServerClient } from '@/lib/supabase/server'

    export default async function MFAEnrollmentPage() {
      const supabase = await createServerClient()
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) {
        redirect('/login')
      }

      // Start enrollment on page load (server action)
      const enrollment = await enrollMFA()

      return (
        <div className="max-w-md mx-auto py-8">
          <h1 className="text-2xl font-bold mb-6">Set up two-factor authentication</h1>

          <div className="bg-white p-6 rounded-lg border shadow">
            <p className="text-gray-600 mb-4">
              Scan this QR code with your authenticator app:
            </p>

            <div className="flex justify-center mb-6">
              <img
                src={enrollment.qrCode}
                alt="MFA QR Code"
                className="border rounded"
              />
            </div>

            <p className="text-sm text-gray-600 mb-4">
              Or enter this code manually:
            </p>

            <code className="block bg-gray-100 p-3 rounded mb-6 text-sm font-mono">
              {enrollment.secret}
            </code>

            <form action={completeEnrollment} className="space-y-4">
              <input type="hidden" name="factorId" value={enrollment.factorId} />

              <div>
                <label htmlFor="code" className="block text-sm font-medium mb-1">
                  Enter 6-digit code from your app
                </label>
                <input
                  type="text"
                  id="code"
                  name="code"
                  maxLength={6}
                  pattern="[0-9]{6}"
                  required
                  placeholder="000000"
                  className="w-full border rounded px-3 py-2 font-mono text-center tracking-widest"
                />
              </div>

              <button
                type="submit"
                className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
              >
                Verify and enable MFA
              </button>
            </form>
          </div>
        </div>
      )
    }
    ```
  </action>
  <verify>
    cat app/\(dashboard\)/settings/security/enroll/page.tsx | grep -c "enrollMFA"
    cat app/\(dashboard\)/settings/security/enroll/page.tsx | grep -c "verifyEnrollment"
  </verify>
  <done>
    "MFA enrollment page created with QR code display and verification form"
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin MFA enforcement middleware</name>
  <files>lib/auth/admin-middleware.ts</files>
  <action>
    Create `lib/auth/admin-middleware.ts` with admin-only access enforcement.

    **requireAdminMFA function:**
    ```typescript
    import { createServerClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'

    export interface AdminContext {
      userId: string
      organizationId: string
      role: 'admin' | 'member'
      hasMFA: boolean
    }

    export async function requireAdminMFA(): Promise<AdminContext> {
      const supabase = await createServerClient()

      // Get current user
      const { data: { user }, error: authError } = await supabase.auth.getUser()

      if (authError || !user) {
        redirect('/login')
      }

      // Get user profile with role
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('organization_id, role')
        .eq('id', user.id)
        .single()

      if (profileError || !profile) {
        redirect('/login')
      }

      // Only admins need MFA enforcement
      if (profile.role !== 'admin') {
        return {
          userId: user.id,
          organizationId: profile.organization_id,
          role: 'member',
          hasMFA: false,
        }
      }

      // Check MFA status
      const { data: factors } = await supabase.auth.mfa.listFactors()
      const hasMFA = factors?.totp?.some(f => f.status === 'verified') ?? false

      if (!hasMFA) {
        // Redirect to MFA enrollment for admins without MFA
        redirect('/settings/security/enroll?required=true')
      }

      return {
        userId: user.id,
        organizationId: profile.organization_id,
        role: 'admin',
        hasMFA: true,
      }
    }
    ```

    **Optional: requireAuthenticated function for any authenticated user:**
    ```typescript
    export async function requireAuthenticated() {
      const supabase = await createServerClient()

      const { data: { user }, error } = await supabase.auth.getUser()

      if (error || !user) {
        redirect('/login')
      }

      return user
    }
    ```
  </action>
  <verify>
    cat lib/auth/admin-middleware.ts | grep -c "requireAdminMFA"
    cat lib/auth/admin-middleware.ts | grep -c "mfa.listFactors"
  </verify>
  <done>
    "lib/auth/admin-middleware.ts created with MFA enforcement for admin accounts"
  </done>
</task>

<task type="auto">
  <name>Task 4: Create MFA API route for challenge verification</name>
  <files>app/api/auth/mfa/challenge/route.ts</files>
  <action>
    Create `app/api/auth/mfa/challenge/route.ts` for programmatic MFA verification.

    This API route allows verifying MFA code for sensitive operations without redirect:
    ```typescript
    import { createServerClient } from '@/lib/supabase/server'
    import { NextResponse } from 'next/server'

    export async function POST(request: Request) {
      const supabase = createServerClient()
      const { factorId, code } = await request.json()

      const { error } = await supabase.auth.mfa.verify({
        factorId,
        code,
      })

      if (error) {
        return NextResponse.json(
          { error: 'Invalid MFA code' },
          { status: 401 }
        )
      }

      return NextResponse.json({ success: true })
    }
    ```

    This enables MFA verification in client-side flows where redirect is not desired.
  </action>
  <verify>
    cat app/api/auth/mfa/challenge/route.ts | grep -c "mfa.verify"
  </verify>
  <done>
    "MFA challenge API route created for programmatic verification"
  </done>
</task>

<task type="auto">
  <name>Task 5: Update dashboard layout to require MFA for admins</name>
  <files>app/(dashboard)/layout.tsx</files>
  <action>
    Update `app/(dashboard)/layout.tsx` to include MFA enforcement.

    Import and call requireAdminMFA in the layout:
    ```tsx
    import { requireAdminMFA } from '@/lib/auth/admin-middleware'

    export default async function DashboardLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      // This will redirect admins without MFA to enrollment
      const adminContext = await requireAdminMFA()

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="bg-white shadow">
            <div className="max-w-7xl mx-auto py-6 px-4">
              <h1 className="text-3xl font-bold text-gray-900">
                Dashboard
              </h1>
            </div>
          </header>
          <main>
            <div className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
              {children}
            </div>
          </main>
        </div>
      )
    }
    ```

    Note: This ensures MFA is enforced on ALL dashboard routes for admin users.
  </action>
  <verify>
    cat app/\(dashboard\)/layout.tsx | grep -c "requireAdminMFA"
  </verify>
  <done>
    "Dashboard layout updated to enforce MFA for admin users"
  </done>
</task>

</tasks>

<verification>
Test MFA enrollment flow:
```bash
# Create admin user account via signup
# Navigate to /dashboard (should redirect to /settings/security/enroll if no MFA)
# Scan QR code with authenticator app
# Enter 6-digit code and verify
# Return to /dashboard (should now allow access)
```

Verify MFA enforcement:
```bash
# Create member user (role='member')
# Login as member (should access dashboard without MFA)
# Login as admin without MFA (should redirect to enrollment)
# Login as admin with MFA (should access dashboard normally)
```
</verification>

<success_criteria>
- [ ] MFA enrollment generates QR code and secret for authenticator apps
- [ ] Verification code successfully completes enrollment
- [ ] Admin users without MFA are redirected to enrollment page
- [ ] Admin users with MFA can access dashboard normally
- [ ] Member users can access dashboard without MFA requirement
- [ ] TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-FOUNDATION/01-05-SUMMARY.md`
</output>
