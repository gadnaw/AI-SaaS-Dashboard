---
phase: 01-foundation
plan: "03"
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - "middleware.ts"
  - "lib/auth/middleware.ts"
  - "app/(auth)/login/page.tsx"
  - "app/(auth)/signup/page.tsx"
  - "app/(auth)/layout.tsx"
  - "lib/actions/auth.ts"
autonomous: true
must_haves:
  truths:
    - "Users can sign up with email/password and automatically create an organization"
    - "Users can log in with email/password"
    - "OAuth providers (Google, GitHub) are configured"
    - "Middleware protects dashboard routes from unauthenticated access"
    - "Session refresh is handled automatically via middleware"
  artifacts:
    - path: "middleware.ts"
      provides: "Next.js middleware for session refresh and route protection"
    - path: "app/(auth)/login/page.tsx"
      provides: "Login page with email/password form"
    - path: "app/(auth)/signup/page.tsx"
      provides: "Signup page with email, password, and organization name"
    - path: "lib/actions/auth.ts"
      provides: "Server actions for login, signup, logout, and OAuth callbacks"
  key_links:
    - from: "middleware.ts"
      to: "lib/supabase/server.ts"
      via: "createServerClient for session validation"
    - from: "app/(auth)/login/page.tsx"
      to: "lib/actions/auth.ts"
      via: "Server action form submission"
    - from: "lib/actions/auth.ts"
      to: "supabase/migrations/001_initial_schema.sql"
      via: "organizations and profiles table inserts on signup"
provides_interface:
  - name: login
    type: server_action
    description: "Server action for email/password login"
  - name: signup
    type: server_action
    description: "Server action for email/password signup with org creation"
  - name: logout
    type: server_action
    description: "Server action for clearing session and redirecting"
  - name: authMiddleware
    type: middleware
    description: "Middleware function for session refresh and route protection"
assumes_from:
  - phase: 1
    interface: createServerClient
    usage: "Used in middleware and server actions for session management"
---

<objective>
Implement complete authentication flows with email/password and OAuth providers. This wave creates the signup experience that auto-creates organizations, login/logout functionality, and middleware protection for all dashboard routes.

Purpose: Working authentication with organization creation during signup
Output: Auth pages, server actions, and protected middleware
</objective>

<execution_context>
{file:~/.config/opencode/gsd/workflows/execute-plan.md}
{file:~/.config/opencode/gsd/templates/summary.md}
</execution_context>

<context>
@.planning/phases/01-FOUNDATION/01-RESEARCH.md

# Auth flow patterns from research
# - @supabase/ssr with PKCE flow
# - Route groups: (auth) and (dashboard)
# - Server actions for form handling
# - Middleware for session refresh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create authentication middleware</name>
  <files>middleware.ts</files>
  <action>
    Create `middleware.ts` in project root for session refresh and route protection.

    Pattern from RESEARCH.md with proper route matching:
    ```typescript
    import { createServerClient } from '@supabase/ssr'
    import { NextResponse, type NextRequest } from 'next/server'

    export async function middleware(request: NextRequest) {
      let supabaseResponse = NextResponse.next({
        request,
      })

      const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
          cookies: {
            getAll() {
              return request.cookies.getAll()
            },
            setAll(cookiesToSet) {
              cookiesToSet.forEach(({ name, value, options }) =>
                request.cookies.set(name, value)
              )
              supabaseResponse = NextResponse.next({
                request,
              })
              cookiesToSet.forEach(({ name, value, options }) =>
                supabaseResponse.cookies.set(name, value, options)
              )
            },
          },
        }
      )

      // IMPORTANT: Avoid writing any logic between createServerClient and
      // supabase.auth.getUser(). A simple mistake could make your application
      // vulnerable to attacks.

      await supabase.auth.getUser()

      return supabaseResponse
    }

    export const config = {
      matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * - api/auth/* (auth API routes)
         * - _next/public (if any)
         */
        '/((?!_next/static|_next/image|favicon.ico|api/auth/*).*)',
      ],
    }
    ```

    Important: Use `getUser()` not `getSession()` for security.
  </action>
  <verify>
    cat middleware.ts | grep -c "createServerClient"
    cat middleware.ts | grep -c "getUser()"
    cat middleware.ts | grep -c "matcher"
  </verify>
  <done>
    "middleware.ts created with session refresh, route protection, and proper PKCE flow"
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth route group layout</name>
  <files>app/(auth)/layout.tsx</files>
  <action>
    Create `app/(auth)/layout.tsx` - the shared layout for auth pages (login, signup, etc.).

    This layout should:
    - NOT include the dashboard sidebar/header
    - Center content on the page
    - Include a link to return to home
    - Use a clean, minimal design appropriate for auth pages

    Example structure:
    ```tsx
    export default function AuthLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      return (
        <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
          <div className="w-full max-w-md">
            {children}
          </div>
        </div>
      )
    }
    ```
  </action>
  <verify>
    ls -la app/\(auth\)/layout.tsx
    cat app/\(auth\)/layout.tsx | grep -c "min-h-screen"
  </verify>
  <done>
    "app/(auth)/layout.tsx created with centered auth-focused layout"
  </done>
</task>

<task type="auto">
  <name>Task 3: Create login page</name>
  <files>app/(auth)/login/page.tsx</files>
  <action>
    Create `app/(auth)/login/page.tsx` with email/password login form.

    Include:
    - Email input field (type="email")
    - Password input field (type="password")
    - Submit button
    - Link to signup page
    - Link to forgot password (can be placeholder for now)
    - OAuth provider buttons (Google, GitHub)

    Form uses Server Action from lib/actions/auth.ts. Display errors below inputs if any.

    Design with Tailwind CSS:
    ```tsx
    import { login } from '@/lib/actions/auth'
    import { Suspense } from 'react'

    export default function LoginPage() {
      return (
        <div className="w-full max-w-md mx-auto">
          <h1 className="text-2xl font-bold text-center mb-6">Sign in to your account</h1>
          <form action={login} className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium">
                Email
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
              />
            </div>
            <div>
              <label htmlFor="password" className="block text-sm font-medium">
                Password
              </label>
              <input
                type="password"
                id="password"
                name="password"
                required
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
              />
            </div>
            <button
              type="submit"
              className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
            >
              Sign in
            </button>
          </form>
          <div className="mt-4 text-center">
            <p className="text-sm text-gray-600">
              Don't have an account?{' '}
              <a href="/signup" className="text-blue-600 hover:underline">
                Sign up
              </a>
            </p>
          </div>
        </div>
      )
    }
    ```
  </action>
  <verify>
    cat app/\(auth\)/login/page.tsx | grep -c "login"
    cat app/\(auth\)/login/page.tsx | grep -c "type=\"email\""
    cat app/\(auth\)/login/page.tsx | grep -c "type=\"password\""
  </verify>
  <done>
    "app/(auth)/login/page.tsx created with email/password form and OAuth buttons"
  </done>
</task>

<task type="auto">
  <name>Task 4: Create signup page</name>
  <files>app/(auth)/signup/page.tsx</files>
  <action>
    Create `app/(auth)/signup/page.tsx` with email/password signup and organization name.

    Include:
    - Organization name input (required - first user becomes admin)
    - Email input field (type="email")
    - Password input field (type="password")
    - Confirm password input field (type="password")
    - Submit button
    - Link to login page

    Form uses Server Action from lib/actions/auth.ts.

    Design similar to login page with organization name field:
    ```tsx
    import { signup } from '@/lib/actions/auth'

    export default function SignupPage() {
      return (
        <div className="w-full max-w-md mx-auto">
          <h1 className="text-2xl font-bold text-center mb-6">Create your account</h1>
          <form action={signup} className="space-y-4">
            <div>
              <label htmlFor="organizationName" className="block text-sm font-medium">
                Organization Name
              </label>
              <input
                type="text"
                id="organizationName"
                name="organizationName"
                required
                placeholder="Acme Inc."
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
              />
            </div>
            <div>
              <label htmlFor="email" className="block text-sm font-medium">
                Email
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
              />
            </div>
            <div>
              <label htmlFor="password" className="block text-sm font-medium">
                Password
              </label>
              <input
                type="password"
                id="password"
                name="password"
                required
                minLength={8}
                className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2"
              />
            </div>
            <button
              type="submit"
              className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
            >
              Create account
            </button>
          </form>
        </div>
      )
    }
    ```
  </action>
  <verify>
    cat app/\(auth\)/signup/page.tsx | grep -c "signup"
    cat app/\(auth\)/signup/page.tsx | grep -c "organizationName"
  </verify>
  <done>
    "app/(auth)/signup/page.tsx created with organization name, email, and password fields"
  </done>
</task>

<task type="auto">
  <name>Task 5: Create auth server actions</name>
  <files>lib/actions/auth.ts</files>
  <action>
    Create `lib/actions/auth.ts` with all authentication server actions.

    **login action:**
    ```typescript
    'use server'

    import { revalidatePath } from 'next/cache'
    import { redirect } from 'next/navigation'
    import { createServerClient } from '@/lib/supabase/server'

    export async function login(formData: FormData) {
      const supabase = await createServerClient()

      const email = formData.get('email') as string
      const password = formData.get('password') as string

      const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (error) {
        return { error: error.message }
      }

      revalidatePath('/', 'layout')
      redirect('/dashboard')
    }
    ```

    **signup action** (creates org + profile + auth user):
    ```typescript
    export async function signup(formData: FormData) {
      const supabase = await createServerClient()

      const email = formData.get('email') as string
      const password = formData.get('password') as string
      const organizationName = formData.get('organizationName') as string

      // Generate slug from organization name
      const slug = organizationName
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '')

      // Create organization first
      const { data: org, error: orgError } = await supabase
        .from('organizations')
        .insert({ name: organizationName, slug })
        .select()
        .single()

      if (orgError) {
        return { error: 'Failed to create organization: ' + orgError.message }
      }

      // Sign up user with organization_id and role in metadata
      const { error: signUpError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            organization_id: org.id,
            role: 'admin',
            full_name: email.split('@')[0],
          },
        },
      })

      if (signUpError) {
        // Clean up organization if signup fails
        await supabase.from('organizations').delete().eq('id', org.id)
        return { error: 'Failed to create account: ' + signUpError.message }
      }

      revalidatePath('/', 'layout')
      redirect('/dashboard')
    }
    ```

    **logout action:**
    ```typescript
    export async function logout() {
      const supabase = await createServerClient()
      await supabase.auth.signOut()
      redirect('/login')
    }
    ```

    Export all actions as named exports.
  </action>
  <verify>
    cat lib/actions/auth.ts | grep -c "export async function"
    cat lib/actions/auth.ts | grep -c "signInWithPassword"
    cat lib/actions/auth.ts | grep -c "signUp"
    cat lib/actions/auth.ts | grep -c "signOut"
  </verify>
  <done>
    "lib/actions/auth.ts created with login, signup, and logout server actions"
  </done>
</task>

<task type="auto">
  <name>Task 6: Create OAuth provider configuration</name>
  <files>app/api/auth/callback/route.ts</files>
  <action>
    Create `app/api/auth/callback/route.ts` for OAuth callback handling.

    This route handles the OAuth callback from providers (Google, GitHub):
    ```typescript
    import { createServerClient } from '@supabase/ssr'
    import { cookies } from 'next/headers'
    import { NextResponse } from 'next/server'

    export async function GET(request: Request) {
      const { searchParams, origin } = new URL(request.url)
      const code = searchParams.get('code')
      const next = searchParams.get('next') ?? '/dashboard'

      if (code) {
        const cookieStore = await cookies()
        const supabase = createServerClient(
          process.env.NEXT_PUBLIC_SUPABASE_URL!,
          process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
          {
            cookies: {
              getAll() {
                return cookieStore.getAll()
              },
              setAll(cookiesToSet) {
                cookiesToSet.forEach(({ name, value, options }) =>
                  cookieStore.set(name, value, options)
                )
              },
            },
          }
        )
        const { error } = await supabase.auth.exchangeCodeForSession(code)
        if (!error) {
          return NextResponse.redirect(`${origin}${next}`)
        }
      }

      // Return the user to an error page with instructions
      return NextResponse.redirect(`${origin}/auth/auth-code-error`)
    }
    ```

    Add OAuth buttons to login page that link to:
    `/auth/signin?provider=google`
    `/auth/signin?provider=github`

    Note: Full OAuth setup requires Supabase Dashboard configuration of provider credentials.
  </action>
  <verify>
    cat app/api/auth/callback/route.ts | grep -c "exchangeCodeForSession"
    cat app/api/auth/callback/route.ts | grep -c "NEXT_PUBLIC_SUPABASE_URL"
  </verify>
  <done>
    "app/api/auth/callback/route.ts created for OAuth provider callbacks"
  </done>
</task>

</tasks>

<verification>
Test auth flow locally:
```bash
# Start dev server
npm run dev

# Test signup flow in browser
# Navigate to http://localhost:3000/signup
# Create organization, verify redirect to /dashboard

# Test login flow
# Logout, navigate to /login
# Sign in with credentials

# Test OAuth (requires provider config in Supabase Dashboard)
# Click OAuth button, verify redirect
```
</verification>

<success_criteria>
- [ ] Middleware refreshes sessions and protects routes
- [ ] Signup creates organization and admin profile in single transaction
- [ ] Login authenticates and redirects to dashboard
- [ ] Logout clears session and redirects to login
- [ ] OAuth callback route exchanges code for session
- [ ] No cross-org data access possible (verified by RLS)
</success_criteria>

<output>
After completion, create `.planning/phases/01-FOUNDATION/01-03-SUMMARY.md`
</output>
